<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>WebGPU game (#4): Depth and Instances | Byron’s Blog</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="WebGPU game (#4): Depth and Instances" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="For today’s post, I’d like to cover two more rendering topics that get us closer to the point that we can focus on making a game out of this project: depth and instances." />
<meta property="og:description" content="For today’s post, I’d like to cover two more rendering topics that get us closer to the point that we can focus on making a game out of this project: depth and instances." />
<link rel="canonical" href="https://blog.batteson.com/graphics/2023/07/06/webgpu-game-4-depth-and-instances.html" />
<meta property="og:url" content="https://blog.batteson.com/graphics/2023/07/06/webgpu-game-4-depth-and-instances.html" />
<meta property="og:site_name" content="Byron’s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-07-06T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="WebGPU game (#4): Depth and Instances" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-07-06T00:00:00+00:00","datePublished":"2023-07-06T00:00:00+00:00","description":"For today’s post, I’d like to cover two more rendering topics that get us closer to the point that we can focus on making a game out of this project: depth and instances.","headline":"WebGPU game (#4): Depth and Instances","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.batteson.com/graphics/2023/07/06/webgpu-game-4-depth-and-instances.html"},"url":"https://blog.batteson.com/graphics/2023/07/06/webgpu-game-4-depth-and-instances.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://blog.batteson.com/feed.xml" title="Byron's Blog" /></head>
<body><header class="site-header" role="banner">
  <script>const OVERRIDE_COLOR_SCHEME_KEY = "override-color-scheme";

function systemScheme() {
  if (window.matchMedia) {
    if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
      return "dark";
    }
    if (window.matchMedia("(prefers-color-scheme: light)").matches) {
      return "light";
    }
  }
  return null;
}

function localStorageScheme() {
  const store = window.localStorage.getItem(OVERRIDE_COLOR_SCHEME_KEY);
  switch (store) {
  case "dark":
    return "dark";
  case "light":
    return "light";
  default:
    return null;
  }
}

function getEffectiveColorScheme() {
  const scheme = localStorageScheme();
  if (scheme) {
    return scheme;
  }
  return systemScheme() ?? "light";
}

function toggleDomStyles(toggle, scheme) {
  if (scheme == "dark") {
    toggle.classList.add("enabled");
    document.documentElement.classList.add("dark");
  } else {
    toggle.classList.remove("enabled");
    document.documentElement.classList.remove("dark");
  }
}

function init() {
  const toggle = document.getElementById("color-scheme-toggle");
  toggleDomStyles(toggle, getEffectiveColorScheme());
  toggle.style.display = "";

  toggle.addEventListener("click", () => {
    const toggledScheme = getEffectiveColorScheme() == "dark" ? "light" : "dark";
    window.localStorage.setItem(OVERRIDE_COLOR_SCHEME_KEY, toggledScheme);
    console.log(toggledScheme);
    toggleDomStyles(toggle, toggledScheme);
  });

  window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", event => {
    const newColorScheme = event.matches ? "dark" : "light";
    localStorage.removeItem(OVERRIDE_COLOR_SCHEME_KEY);
    toggleDomStyles(toggle, newColorScheme);
  });
}

// Prevent start-up flash bang.
if (getEffectiveColorScheme() == "dark") {
  document.documentElement.classList.add("dark");
} else {
  document.documentElement.classList.remove("dark");
}

document.addEventListener("DOMContentLoaded", init);
</script>

  <div class="wrapper"><a class="site-title" rel="author" href="/">Byron&#39;s Blog</a>

    <div class="toggle-wrapper">
      <div aria-label="Dark mode toggle" class="toggle" id="color-scheme-toggle" style="display: none;">
        <div class="icons">
          <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 39.319016 39.339096">
  <g transform="translate(-55.96962,-5.914348)">
    <path style="stroke-linecap:round;stroke-linejoin:round;paint-order:stroke markers fill" d="m 75.706175,5.9145455 c -0.46813,-0.00211 -0.936357,0.012689 -1.403532,0.044442 -0.934573,0.063571 -1.863148,0.1947352 -2.779159,0.3906739 -0.91589,0.1960373 -1.816773,0.4569633 -2.695442,0.7813476 -0.878744,0.324236 -1.732777,0.7100078 -2.556433,1.1560018 -0.823583,0.4459808 -1.613495,0.9513444 -2.365231,1.5099854 -0.751784,0.5587278 -1.462386,1.1698288 -2.127002,1.8298618 -0.664716,0.659966 -1.281858,1.367265 -1.845882,2.115117 -0.563861,0.747916 -1.073806,1.535378 -1.525488,2.355928 -0.451665,0.820669 -0.845378,1.672084 -1.175639,2.548682 h 0.0021 c -0.330339,0.876352 -0.598711,1.774801 -0.800985,2.689241 -0.202397,0.914588 -0.339623,1.843528 -0.409794,2.777609 -0.06995,0.934098 -0.07147,1.872003 -0.0078,2.806547 0.06361,0.934382 0.19268,1.863336 0.388607,2.779158 0.195766,0.915422 0.457365,1.817172 0.781347,2.695443 0.324276,0.878549 0.710017,1.732964 1.156002,2.556433 0.446127,0.823809 0.951138,1.613314 1.509985,2.36523 0.55873,0.751786 1.169829,1.462389 1.829863,2.127002 a 3.50035,3.50035 0 0 0 0,0.0021 c 0.659997,0.664523 1.367272,1.279977 2.115116,1.843816 0.747917,0.563861 1.534862,1.073805 2.355412,1.525488 0.820454,0.451817 1.672795,0.84518 2.549198,1.175639 0.876539,0.330379 1.774606,0.596657 2.689242,0.798917 0.914426,0.202167 1.843719,0.338251 2.777608,0.408244 0.934072,0.07011 1.869939,0.07492 2.80448,0.01137 a 3.50035,3.50035 0 0 0 0.0021,0 c 0.934573,-0.06357 1.863148,-0.194217 2.779159,-0.390157 0.91589,-0.196037 1.816771,-0.456963 2.695443,-0.781348 0.878744,-0.324234 1.732776,-0.710525 2.556433,-1.156518 0.823582,-0.445982 1.613495,-0.950827 2.36523,-1.509469 0.751783,-0.558728 1.462388,-1.170347 2.127002,-1.830379 a 3.50035,3.50035 0 0 0 0.0021,0 c 0.664556,-0.66018 1.279986,-1.367071 1.843815,-2.115117 0.563825,-0.747733 1.073796,-1.535059 1.525488,-2.355411 0.451858,-0.820638 0.843123,-1.672082 1.173572,-2.548682 0.330339,-0.876351 0.598711,-1.775317 0.800985,-2.689758 a 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.16e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 c 0.0042,-0.019 0.0094,-0.03783 0.01344,-0.05684 l 0.0021,-0.01188 c 0.0042,-0.01897 0.0078,-0.03735 0.01189,-0.05633 a 3.50035,3.50035 0 0 0 0.0036,-0.01602 c 0.004,-0.01898 0.008,-0.03734 0.01188,-0.05633 l 0.0016,-0.01188 c 0.004,-0.01898 0.008,-0.03734 0.01188,-0.05633 a 3.50035,3.50035 0 0 0 0.0041,-0.01395 c 0.0022,-0.01077 0.0035,-0.0223 0.0057,-0.03307 l 0.0041,-0.0217 c 10e-4,-0.0051 0.0026,-0.01035 0.0036,-0.0155 0.0023,-0.01093 0.0056,-0.02214 0.0078,-0.03307 a 3.50035,3.50035 0 0 0 0.0078,-0.04289 c 0.0037,-0.01901 0.0083,-0.03783 0.01189,-0.05684 l 0.0021,-0.01189 c 0.0032,-0.01637 0.0066,-0.0322 0.0098,-0.04858 l 0.0021,-0.0078 c 0.0039,-0.02042 0.0059,-0.04002 0.0098,-0.06046 a 3.50035,3.50035 0 0 0 0.0036,-0.01189 c 0.0038,-0.02027 0.0061,-0.04018 0.0098,-0.06046 l 0.0021,-0.0078 c 0.0038,-0.02045 0.0082,-0.04 0.01189,-0.06046 a 3.50035,3.50035 0 0 0 0.0021,-0.01395 c 0.0032,-0.01837 0.0066,-0.0364 0.0098,-0.05478 l 0.0021,-0.01344 c 0.0026,-0.01479 0.0052,-0.03016 0.0078,-0.04496 l 0.0016,-0.01188 c 0.0034,-0.01917 0.0064,-0.03715 0.0098,-0.05633 a 3.50035,3.50035 0 0 0 0.0021,-0.01395 c 0.0039,-0.02295 0.0081,-0.04524 0.01189,-0.06821 0.0035,-0.02062 0.0064,-0.0419 0.0098,-0.06253 a 3.50035,3.50035 0 0 0 0.0021,-0.01188 c 0.0031,-0.01919 0.0067,-0.03713 0.0098,-0.05633 l 0.0021,-0.01188 c 0.0031,-0.01919 0.0067,-0.03764 0.0098,-0.05684 a 3.50035,3.50035 0 0 0 0.0021,-0.01344 c 0.0034,-0.02233 0.0059,-0.04431 0.0093,-0.06666 v -0.0021 c 0.0034,-0.02254 0.0065,-0.04565 0.0098,-0.06821 a 3.50035,3.50035 0 0 0 0.0041,-0.01757 c 0.0033,-0.02318 0.0066,-0.04709 0.0098,-0.07028 0.0013,-0.009 0.0023,-0.01841 0.0036,-0.02739 a 3.50035,3.50035 0 0 0 0.0062,-0.04082 c 0.0031,-0.0232 0.0048,-0.04707 0.0078,-0.07028 v 0.01344 c 0.0031,-0.0232 0.0048,-0.04707 0.0078,-0.07028 v 0.01395 c 0.0031,-0.0232 0.0048,-0.04708 0.0078,-0.07028 a 3.50035,3.50035 0 0 0 0.0021,-0.01757 c 0.0024,-0.01933 0.0054,-0.03958 0.0078,-0.05891 l 0.0021,-0.01188 c 0.0019,-0.01523 0.0038,-0.02921 0.0057,-0.04444 l 0.0021,-0.01189 c 0.0024,-0.01933 0.0038,-0.03906 0.0062,-0.05839 a 3.50035,3.50035 0 0 0 0.0021,-0.01189 c 0.0028,-0.02323 0.0051,-0.04497 0.0078,-0.06821 a 3.50035,3.50035 0 0 0 0.0021,-0.01757 c 0.0021,-0.01934 0.0036,-0.03956 0.0057,-0.05891 l 0.0021,-0.01188 c 0.0018,-0.01662 0.0039,-0.03196 0.0057,-0.04858 v -0.0078 c 0.0023,-0.02085 0.004,-0.04167 0.0062,-0.06253 a 3.50035,3.50035 0 0 0 0.0021,-0.0078 c 0.0024,-0.02326 0.0055,-0.04702 0.0078,-0.07028 l -0.0021,0.0057 c 0.0017,-0.01728 0.004,-0.03335 0.0057,-0.05064 v -0.0021 c 0.0023,-0.0226 0.0039,-0.04354 0.0062,-0.06615 a 3.50035,3.50035 0 0 0 0.0036,-0.02584 c 0.0022,-0.02327 0.0041,-0.04493 0.0062,-0.06821 a 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.16e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.16e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.16e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.16e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.16e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.16e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 c 0.0017,-0.01999 0.004,-0.03892 0.0057,-0.05891 v -0.0098 c 0.0013,-0.01565 0.0028,-0.03086 0.0041,-0.04651 l 0.0016,-0.01395 c 0.0016,-0.01861 0.0026,-0.03616 0.0041,-0.05478 a 3.50035,3.50035 0 0 0 0.0021,-0.01912 c 0.0014,-0.01796 0.0023,-0.03475 0.0036,-0.05271 l 0.0021,-0.01602 v -0.0036 l 0.0021,-0.01964 v -0.01964 l 0.0021,-0.01964 a 3.50035,3.50035 0 0 0 0.0021,-0.03876 l 0.0021,-0.01395 a 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.16e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.16e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.16e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.16e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.16e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 l 0.0021,-0.02532 a 3.50035,3.50035 0 0 0 0,-5.16e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.16e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.16e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 l 0.0016,-0.0155 a 3.50035,3.50035 0 0 0 0,-5.16e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.16e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.16e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.16e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.16e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 l 0.0021,-0.02739 a 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.16e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.16e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.16e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0.0041,-0.05116 3.50035,3.50035 0 0 0 0.0021,-0.03876 v 0.02119 a 3.50035,3.50035 0 0 0 0.0021,-0.04082 3.50035,3.50035 0 0 0 0.0021,-0.03927 l 0.0015,-0.01912 v -0.01757 l 0.0021,-0.01964 v -0.01964 l 0.0021,-0.01964 a 3.50035,3.50035 0 0 0 0.0021,-0.0646 v -0.01137 a 3.50035,3.50035 0 0 0 -3.929476,-3.589962 h -0.0021 a 3.50035,3.50035 0 0 0 -2.396753,1.415934 c -0.166431,0.22891 -0.349245,0.446336 -0.538985,0.656291 -0.315992,0.320239 -0.656298,0.618452 -1.021644,0.881083 -0.377732,0.271558 -0.777675,0.508712 -1.196826,0.710551 -0.419091,0.201838 -0.854991,0.366472 -1.302763,0.492477 -0.447901,0.125939 -0.906458,0.211627 -1.369425,0.257865 a 3.50035,3.50035 0 0 0 0,0.0021 c -0.462829,0.04634 -0.928836,0.05022 -1.39268,0.0155 -0.463944,-0.03484 -0.923748,-0.109912 -1.374593,-0.224792 -0.450781,-0.114789 -0.890647,-0.267573 -1.314648,-0.458887 -0.426277,-0.191319 -0.832581,-0.419497 -1.21698,-0.681612 -0.384356,-0.262102 -0.744969,-0.557771 -1.077971,-0.882634 -0.333008,-0.324847 -0.636931,-0.679043 -0.908471,-1.056783 -0.271558,-0.377732 -0.511296,-0.778192 -0.713135,-1.197343 -0.201847,-0.419196 -0.36598,-0.85488 -0.49196,-1.302763 -0.125928,-0.447794 -0.211599,-0.903984 -0.257865,-1.366841 a 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.16e-4 c -0.04635,-0.462937 -0.05232,-0.928729 -0.01757,-1.39268 0.03485,-0.463834 0.109938,-0.922304 0.224792,-1.373043 a 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 3.50035,3.50035 0 0 0 0,-5.16e-4 3.50035,3.50035 0 0 0 0,-5.17e-4 c 0.114778,-0.450893 0.267547,-0.890542 0.458887,-1.314648 0.191385,-0.423967 0.419521,-0.830618 0.681612,-1.214913 0.262095,-0.38447 0.557747,-0.744866 0.882634,-1.077971 0.312251,-0.320097 0.654693,-0.609386 1.015958,-0.872815 0.19844,-0.128683 0.400176,-0.25269 0.609265,-0.363285 a 3.50035,3.50035 0 0 0 -1.27295,-6.5741648 c -0.06175,-0.00646 -0.123708,-0.011694 -0.185518,-0.01757 a 3.50035,3.50035 0 0 0 -0.07028,-0.00568 c -0.466941,-0.03505 -0.934886,-0.054225 -1.403015,-0.056332 z M 88.290936,26.265758 a 3.50035,3.50035 0 0 0 0,0.0057 l -0.0021,0.0078 z"/>
  </g>
</svg>

          <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 42.62323 42.62479">
  <g transform="translate(-3.9940714,-3.6876297)">
    <path d="m 25.306465,3.6876302 a 3.5,3.5 0 0 0 -1.081587,0.171049 3.5,3.5 0 0 0 -0.975651,0.4971272 3.5,3.5 0 0 0 -0.774113,0.7746298 3.5,3.5 0 0 0 -0.497128,0.975651 3.5,3.5 0 0 0 -0.171565,1.0815877 v 4.3527061 a 13.959908,13.959908 0 0 1 1.075386,-0.288355 13.959908,13.959908 0 0 1 2.424142,-0.211873 v 0 a 13.959908,13.959908 0 0 1 0.842842,0.02532 13.959908,13.959908 0 0 1 0.839742,0.07648 13.959908,13.959908 0 0 1 0.833541,0.126608 13.959908,13.959908 0 0 1 0.824756,0.17725 13.959908,13.959908 0 0 1 0.15968,0.04444 V 7.1876749 A 3.5,3.5 0 0 0 28.781189,6.7654785 3.5,3.5 0 0 0 28.704708,6.35 3.5,3.5 0 0 0 28.579134,5.946407 3.5,3.5 0 0 0 28.405501,5.5609008 3.5,3.5 0 0 0 28.18691,5.1991658 3.5,3.5 0 0 0 27.926461,4.8663696 3.5,3.5 0 0 0 27.627771,4.5676798 3.5,3.5 0 0 0 27.294975,4.3072306 3.5,3.5 0 0 0 26.93324,4.0886393 3.5,3.5 0 0 0 26.547733,3.9150065 3.5,3.5 0 0 0 26.14414,3.7894328 3.5,3.5 0 0 0 25.728662,3.7129516 3.5,3.5 0 0 0 25.306465,3.6876302 Z" style="stroke-linecap:round;stroke-linejoin:round" />
    <path style="stroke-linecap:round;stroke-linejoin:round" d="m 21.806421,38.459668 v 4.352706 c 8.2e-5,0.367296 0.05798,0.732295 0.171565,1.081587 0.113494,0.349284 0.281257,0.678532 0.497128,0.975651 0.215792,0.297229 0.477028,0.55864 0.774113,0.77463 0.297119,0.21587 0.626367,0.383633 0.975651,0.497127 0.34932,0.113411 0.714318,0.171134 1.081587,0.171049 0.36727,8.5e-5 0.732268,-0.05764 1.081588,-0.171049 0.349284,-0.113494 0.678532,-0.281257 0.975651,-0.497127 0.297268,-0.215948 0.558682,-0.477362 0.77463,-0.77463 0.21587,-0.297119 0.383633,-0.626367 0.497127,-0.975651 0.113411,-0.34932 0.171134,-0.714318 0.171049,-1.081587 v -4.352706 c -0.354824,0.110406 -0.71392,0.206602 -1.07642,0.288354 -0.800336,0.14105 -1.611471,0.211944 -2.424141,0.211874 -0.812671,7e-5 -1.623805,-0.07082 -2.424142,-0.211874 -0.362152,-0.08178 -0.720903,-0.177975 -1.075386,-0.288354 z" />
    <path style="stroke-linecap:round;stroke-linejoin:round" d="m 13.281877,32.073494 -3.045293,3.045809 c -0.2599547,0.259594 -0.4774205,0.558501 -0.6444047,0.885734 -0.166806,0.327347 -0.2810324,0.67892 -0.3384806,1.041797 -0.057507,0.362915 -0.057507,0.732626 0,1.09554 0.057448,0.362877 0.1716746,0.714451 0.3384806,1.041797 0.1669381,0.327417 0.384406,0.626501 0.6444047,0.886251 0.259669,0.259588 0.558572,0.476702 0.885734,0.643372 0.327186,0.166754 0.678581,0.280979 1.041281,0.33848 0.362745,0.05745 0.732277,0.05745 1.095023,0 0.3627,-0.0575 0.714095,-0.171726 1.04128,-0.33848 0.327163,-0.16667 0.626065,-0.383784 0.885734,-0.643372 l 3.046326,-3.046326 c -0.668823,-0.389953 -1.304055,-0.834875 -1.899109,-1.330151 -0.299172,-0.274161 -0.586251,-0.56124 -0.860413,-0.860413 -0.299172,-0.274161 -0.586251,-0.56124 -0.860412,-0.860412 -0.4953,-0.595219 -0.940222,-1.230625 -1.330151,-1.899626 z" />
    <path style="stroke-linecap:round;stroke-linejoin:round" d="m 7.4941162,21.499979 c -0.3672974,8.3e-5 -0.7322949,0.05798 -1.0815878,0.171566 -0.3492843,0.113494 -0.6785311,0.281257 -0.975651,0.497128 -0.2970451,0.215834 -0.5582787,0.477067 -0.7741129,0.774112 -0.2158708,0.29712 -0.3836332,0.626367 -0.4971273,0.975652 -0.1135863,0.349292 -0.1714836,0.71429 -0.1715658,1.081587 8.22e-5,0.367298 0.05798,0.732295 0.1715658,1.081588 0.1134941,0.349284 0.2812565,0.678531 0.4971273,0.975651 0.2158342,0.297045 0.4770678,0.558279 0.7741129,0.774113 0.2971199,0.215871 0.6263667,0.383633 0.975651,0.497127 0.3492929,0.113586 0.7142904,0.171484 1.0815878,0.171566 h 4.3521888 c -0.110393,-0.354655 -0.206588,-0.713576 -0.288354,-1.075903 -0.14105,-0.800338 -0.211944,-1.61147 -0.211874,-2.424142 -7e-5,-0.812672 0.07082,-1.623803 0.211874,-2.424141 0.08177,-0.362327 0.177961,-0.721249 0.288354,-1.075904 z" />
    <path d="m 13.281877,17.926554 a 13.959908,13.959908 0 0 1 1.330151,-1.899625 13.959908,13.959908 0 0 1 0.860412,-0.860413 v 0 a 13.959908,13.959908 0 0 1 0.860413,-0.860413 13.959908,13.959908 0 0 1 1.899109,-1.330151 L 15.185636,9.9296264 A 3.5,3.5 0 0 0 14.460616,9.373588 3.5,3.5 0 0 0 13.61674,9.0237385 3.5,3.5 0 0 0 12.710852,8.904366 3.5,3.5 0 0 0 11.804964,9.0237385 3.5,3.5 0 0 0 10.961088,9.373588 3.5,3.5 0 0 0 10.236584,9.9296264 3.5,3.5 0 0 0 9.5921793,10.815877 a 3.5,3.5 0 0 0 -0.3384806,1.041797 3.5,3.5 0 0 0 0,1.09554 3.5,3.5 0 0 0 0.3384806,1.041797 3.5,3.5 0 0 0 0.6444047,0.885734 z" style="stroke-linecap:round;stroke-linejoin:round" />
    <path d="m 37.330021,32.074011 a 13.959908,13.959908 0 0 1 -1.330151,1.899109 13.959908,13.959908 0 0 1 -0.860413,0.860412 v 0 a 13.959908,13.959908 0 0 1 -0.860413,0.860413 13.959908,13.959908 0 0 1 -1.898592,1.329635 l 3.045292,3.046842 a 3.5,3.5 0 0 0 0.885734,0.643372 3.5,3.5 0 0 0 1.041281,0.33848 3.5,3.5 0 0 0 1.095023,0 3.5,3.5 0 0 0 1.04128,-0.33848 3.5,3.5 0 0 0 0.885734,-0.643372 3.5,3.5 0 0 0 0.280603,-0.31626 3.5,3.5 0 0 0 0.240296,-0.348299 3.5,3.5 0 0 0 0.19637,-0.374137 3.5,3.5 0 0 0 0.150379,-0.395325 3.5,3.5 0 0 0 0.100769,-0.410311 3.5,3.5 0 0 0 0.05116,-0.420129 3.5,3.5 0 0 0 0,-0.422713 3.5,3.5 0 0 0 -0.05116,-0.419613 3.5,3.5 0 0 0 -0.100769,-0.410311 3.5,3.5 0 0 0 -0.150379,-0.395325 3.5,3.5 0 0 0 -0.19637,-0.374654 3.5,3.5 0 0 0 -0.240296,-0.347782 3.5,3.5 0 0 0 -0.280603,-0.31626 z" style="stroke-linecap:round;stroke-linejoin:round" />
    <path d="m 38.815718,21.499979 a 13.959908,13.959908 0 0 1 0.04444,0.159164 13.959908,13.959908 0 0 1 0.17725,0.824756 13.959908,13.959908 0 0 1 0.126607,0.833541 13.959908,13.959908 0 0 1 0.07648,0.839742 13.959908,13.959908 0 0 1 0.02532,0.842842 v 0 a 13.959908,13.959908 0 0 1 -0.211873,2.424142 13.959908,13.959908 0 0 1 -0.288355,1.075903 h 4.351672 a 3.5,3.5 0 0 0 1.081588,-0.171566 3.5,3.5 0 0 0 0.975651,-0.497127 3.5,3.5 0 0 0 0.774113,-0.774113 3.5,3.5 0 0 0 0.497127,-0.975651 3.5,3.5 0 0 0 0.171566,-1.081588 3.5,3.5 0 0 0 -0.02584,-0.421679 3.5,3.5 0 0 0 -0.07596,-0.415996 3.5,3.5 0 0 0 -0.125574,-0.403593 3.5,3.5 0 0 0 -0.173633,-0.385506 3.5,3.5 0 0 0 -0.218591,-0.361735 3.5,3.5 0 0 0 -0.260966,-0.332279 3.5,3.5 0 0 0 -0.29869,-0.299207 3.5,3.5 0 0 0 -0.332796,-0.260449 3.5,3.5 0 0 0 -0.361735,-0.218591 3.5,3.5 0 0 0 -0.38499,-0.173633 3.5,3.5 0 0 0 -0.403593,-0.125574 3.5,3.5 0 0 0 -0.415995,-0.07648 3.5,3.5 0 0 0 -0.42168,-0.02532 z" style="stroke-linecap:round;stroke-linejoin:round" />
    <path d="m 32.384586,12.972335 a 13.959908,13.959908 0 0 1 0.143144,0.08113 13.959908,13.959908 0 0 1 0.708484,0.457853 13.959908,13.959908 0 0 1 0.679028,0.499711 13.959908,13.959908 0 0 1 0.648023,0.540019 13.959908,13.959908 0 0 1 0.613916,0.577742 v 0 a 13.959908,13.959908 0 0 1 0.577742,0.613916 13.959908,13.959908 0 0 1 0.540019,0.648023 13.959908,13.959908 0 0 1 0.499711,0.679028 13.959908,13.959908 0 0 1 0.457853,0.708484 13.959908,13.959908 0 0 1 0.08113,0.144177 l 3.041158,-3.041675 a 3.5,3.5 0 0 0 0.280603,-0.316259 3.5,3.5 0 0 0 0.240296,-0.347783 3.5,3.5 0 0 0 0.19637,-0.374654 3.5,3.5 0 0 0 0.150379,-0.395325 3.5,3.5 0 0 0 0.100769,-0.410311 3.5,3.5 0 0 0 0.05116,-0.419612 3.5,3.5 0 0 0 0,-0.422713 3.5,3.5 0 0 0 -0.05116,-0.42013 3.5,3.5 0 0 0 -0.100769,-0.410311 3.5,3.5 0 0 0 -0.150379,-0.395324 3.5,3.5 0 0 0 -0.19637,-0.374138 A 3.5,3.5 0 0 0 40.655399,10.245886 3.5,3.5 0 0 0 40.374796,9.9296264 3.5,3.5 0 0 0 39.650293,9.373588 3.5,3.5 0 0 0 38.806417,9.0237385 3.5,3.5 0 0 0 37.900529,8.904366 3.5,3.5 0 0 0 36.994641,9.0237385 3.5,3.5 0 0 0 36.150765,9.373588 3.5,3.5 0 0 0 35.425744,9.9296264 Z" style="stroke-linecap:round;stroke-linejoin:round" />
    <circle style="stroke-width:7;stroke-linecap:round;stroke-linejoin:round;stroke-dasharray:none" id="path1-9" cx="25.305944" cy="25" r="10.515897"/>
  </g>
</svg>

        </div>
      </div>
    </div><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a><a class="page-link" href="/archives/">Archives</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <link rel="stylesheet" href="/assets/katex.min.css" />

<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">WebGPU game (#4): Depth and Instances</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2023-07-06T00:00:00+00:00" itemprop="datePublished">Jul 6, 2023
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>For today’s post, I’d like to cover two more rendering topics that get us closer
to the point that we can focus on making a game out of this project: depth and
instances.</p>

<h2 id="depth-buffer">Depth buffer</h2>

<p>The question we now have to ask ourselves is: how does the graphics card know
which triangles are in front? The answer is that the information is available
from the NDC coordinates, but you need to configure a buffer to store this
information. If you don’t, you get the following:</p>

<p><img src="/assets/webgpu-game-4-depth-and-instances/cube-overlap.png" alt="Cube overlap" class="centered" /></p>

<p>We’re essentially seeing triangles rendered in order (roughly – your GPU can
also just reorder triangle processing for parallelization purposes). Let’s
reproduce this issue, first, by defining a cube<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup>. We remove the old vertices
and update the indices as follows:</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">cube</span> <span class="o">=</span> <span class="p">[</span>
  <span class="c1">// x, y, z, u, v, atlas index</span>
  <span class="c1">// front</span>
  <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
  <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
  <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
  <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>

  <span class="c1">// back</span>
  <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
  <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
  <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
  <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>

  <span class="c1">// right</span>
  <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
  <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
  <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
  <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>

  <span class="c1">// left</span>
  <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
  <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
  <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
  <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>

  <span class="c1">// top</span>
  <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
  <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
  <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
  <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
<span class="p">];</span>

<span class="kd">const</span> <span class="nx">vertices</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Float32Array</span><span class="p">(</span><span class="nx">cube</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">values</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">[</span>
      <span class="nx">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
      <span class="nx">values</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
      <span class="nx">values</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
      <span class="p">...</span><span class="nx">uvFromIndex</span><span class="p">(</span><span class="nx">values</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="nx">values</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="nx">values</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="nx">texture</span><span class="p">),</span>
  <span class="p">];</span>
<span class="p">}).</span><span class="nx">flat</span><span class="p">());</span>

<span class="p">...</span>

<span class="c1">// We are working with quads, so we can map our indices to multiples of 4 vertices.</span>
<span class="kd">const</span> <span class="nx">planes</span> <span class="o">=</span> <span class="nx">cube</span><span class="p">.</span><span class="nx">length</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">indices</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Uint32Array</span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="k">from</span><span class="p">({</span><span class="na">length</span><span class="p">:</span> <span class="nx">planes</span><span class="p">}).</span><span class="nx">map</span><span class="p">((</span><span class="nx">_</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">([</span>
  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span>
<span class="p">]).</span><span class="nx">map</span><span class="p">(</span><span class="nx">x</span> <span class="o">=&gt;</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)).</span><span class="nx">flat</span><span class="p">());</span>
</code></pre></div></div>

<p>You should see the same issue as pictured above. Now, we can solve this for
convex models by turning on back-face culling. Back-face culling essentially
allows the graphics card to eliminate a triangle as a candidate for
rasterization quite cheaply. I’m going to solve the general case which resolves
this issue for scenes with multiple and concave models. At the end of this
section we can turn on back-face culling as an optimization<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup>.</p>

<p>For our depth information, we’re going to use a texture instead of an opaque
primitive buffer. I’m not actually sure why this is the convention, but I assume
it’s because the buffer does actually represent values at specific pixels in 2D
space. For this, we can define a helper method in our <code class="language-plaintext highlighter-rouge">texture.ts</code> file:</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="k">async</span> <span class="kd">function</span> <span class="nx">createDepthTexture</span><span class="p">(</span>
  <span class="nx">device</span><span class="p">:</span> <span class="nx">GPUDevice</span><span class="p">,</span>
  <span class="nx">width</span><span class="p">:</span> <span class="kr">number</span><span class="p">,</span>
  <span class="nx">height</span><span class="p">:</span> <span class="kr">number</span>
<span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">GPUTexture</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="na">textureDescriptor</span><span class="p">:</span> <span class="nx">GPUTextureDescriptor</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">label</span><span class="p">:</span> <span class="dl">"</span><span class="s2">depth texture</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">size</span><span class="p">:</span> <span class="p">{</span> <span class="na">width</span><span class="p">:</span> <span class="nx">width</span><span class="p">,</span> <span class="na">height</span><span class="p">:</span> <span class="nx">height</span> <span class="p">},</span>
    <span class="na">usage</span><span class="p">:</span> <span class="nx">GPUTextureUsage</span><span class="p">.</span><span class="nx">TEXTURE_BINDING</span> <span class="o">|</span> <span class="nx">GPUTextureUsage</span><span class="p">.</span><span class="nx">COPY_DST</span> <span class="o">|</span> <span class="nx">GPUTextureUsage</span><span class="p">.</span><span class="nx">RENDER_ATTACHMENT</span><span class="p">,</span>
    <span class="na">format</span><span class="p">:</span> <span class="dl">"</span><span class="s2">depth32float</span><span class="dl">"</span><span class="p">,</span>
  <span class="p">};</span>

  <span class="kd">const</span> <span class="nx">texture</span> <span class="o">=</span> <span class="nx">device</span><span class="p">.</span><span class="nx">createTexture</span><span class="p">(</span><span class="nx">textureDescriptor</span><span class="p">);</span>

  <span class="k">return</span> <span class="nx">texture</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We can then create our depth texture and a view into that texture.</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">depthTexture</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">createDepthTexture</span><span class="p">(</span><span class="nx">device</span><span class="p">,</span> <span class="nx">SCREEN_WIDTH</span><span class="p">,</span> <span class="nx">SCREEN_HEIGHT</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">depthView</span> <span class="o">=</span> <span class="nx">depthTexture</span><span class="p">.</span><span class="nx">createView</span><span class="p">();</span>
</code></pre></div></div>

<p>I’ve updated the camera to be a bit higher up (by 3 units) and looking down at
the scene by 0.5 radians.</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">camera</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Camera</span><span class="p">(</span><span class="k">new</span> <span class="nx">Vec3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">));</span>
<span class="nx">camera</span><span class="p">.</span><span class="nx">pitch</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">;</span>
</code></pre></div></div>

<p>Now, we need to update our pipeline descriptor with the <code class="language-plaintext highlighter-rouge">depthStencil</code>
information. You can ignore the “stencil”<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">3</a></sup> part of the name for the purpose
of this series, I don’t intend to use it. Otherwise, we’re specifying that
render passes should write to the depth buffer, and only when the new fragment
has a depth value less than the old one. Otherwise, we just specify the format
of the buffer (same as the format specified in the <code class="language-plaintext highlighter-rouge">createDepthTexture</code>
function).</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">pipeline</span> <span class="o">=</span> <span class="nx">device</span><span class="p">.</span><span class="nx">createRenderPipeline</span><span class="p">({</span>
  <span class="p">...</span>
  <span class="na">depthStencil</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">depthCompare</span><span class="p">:</span> <span class="dl">"</span><span class="s2">less</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">depthWriteEnabled</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">format</span><span class="p">:</span> <span class="dl">"</span><span class="s2">depth32float</span><span class="dl">"</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">});</span>
</code></pre></div></div>

<p>For our render pass we specify the actual attachment with a clear value of 1.0,
since we assume values near zero are closest to the camera. We also specify that
the depth buffer should be cleared on the start of each pass and the values
should be stored after the pass. We may want to use the depth texture in
subsequent passes.</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">pass</span> <span class="o">=</span> <span class="nx">encoder</span><span class="p">.</span><span class="nx">beginRenderPass</span><span class="p">({</span>
  <span class="p">...</span>
  <span class="na">depthStencilAttachment</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">view</span><span class="p">:</span> <span class="nx">depthView</span><span class="p">,</span>
    <span class="na">depthClearValue</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="na">depthLoadOp</span><span class="p">:</span> <span class="dl">"</span><span class="s2">clear</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">depthStoreOp</span><span class="p">:</span> <span class="dl">"</span><span class="s2">store</span><span class="dl">"</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">});</span>
</code></pre></div></div>

<p><img src="/assets/webgpu-game-4-depth-and-instances/cube-fixed.png" alt="Cube with overlap fixed" class="centered" /></p>

<p>Finally, we can enable back-face culling back in our pipeline definition as an
optimization. Visually, this changes nothing. If you’d like, remove the
<code class="language-plaintext highlighter-rouge">depthStencil</code> configuration and <code class="language-plaintext highlighter-rouge">depthStencilAttachment</code> temporarily to see how
back-back culling actually resolves the issue for this simple cube. Or, switch
the <code class="language-plaintext highlighter-rouge">cullMode</code> to <code class="language-plaintext highlighter-rouge">"front"</code> to see only the inside of the cube rendered! The
normal direction is determined via the “winding” of the triangle, not an
explicitly provided normal. You’ll now notice I specified all of the triangles
using a counter-clockwise winding<sup id="fnref:4" role="doc-noteref"><a href="#fn:4" class="footnote" rel="footnote">4</a></sup>.</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">pipeline</span> <span class="o">=</span> <span class="nx">device</span><span class="p">.</span><span class="nx">createRenderPipeline</span><span class="p">({</span>
  <span class="p">...</span>
  <span class="na">primitive</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">topology</span><span class="p">:</span> <span class="dl">"</span><span class="s2">triangle-list</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">frontFace</span><span class="p">:</span> <span class="dl">"</span><span class="s2">ccw</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">cullMode</span><span class="p">:</span> <span class="dl">"</span><span class="s2">back</span><span class="dl">"</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">});</span>
</code></pre></div></div>

<h2 id="instances">Instances</h2>

<p>From the <a href="/graphics/2023/07/04/webgpu-game-3-textures-and-projections.html">previous</a>
post, we implemented the view and projection matrices, but omitted the model
matrix. The following sets up the buffer for use, but we’re just going to use an
identity matrix, for now.</p>

<p>So, first, in the <code class="language-plaintext highlighter-rouge">mat4.ts</code> file add the following static method (if you haven’t
already):</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="nx">identity</span><span class="p">():</span> <span class="nx">Mat4</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nx">Mat4</span><span class="p">(</span>
    <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
    <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
    <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
    <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
  <span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We now need to create our model matrix (we’ll interchangeably use the word
“instance” to describe this data).</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">instance</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Float32Array</span><span class="p">(</span><span class="nx">Mat4</span><span class="p">.</span><span class="nx">identity</span><span class="p">().</span><span class="nx">buffer</span><span class="p">());</span>
<span class="kd">const</span> <span class="nx">instanceBuffer</span> <span class="o">=</span> <span class="nx">device</span><span class="p">.</span><span class="nx">createBuffer</span><span class="p">({</span>
  <span class="na">label</span><span class="p">:</span> <span class="dl">"</span><span class="s2">instance buffer</span><span class="dl">"</span><span class="p">,</span>
  <span class="na">size</span><span class="p">:</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">,</span>
  <span class="na">usage</span><span class="p">:</span> <span class="nx">GPUBufferUsage</span><span class="p">.</span><span class="nx">VERTEX</span> <span class="o">|</span> <span class="nx">GPUBufferUsage</span><span class="p">.</span><span class="nx">COPY_DST</span><span class="p">,</span>
<span class="p">});</span>
<span class="nx">device</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nx">writeBuffer</span><span class="p">(</span><span class="nx">instanceBuffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">instance</span><span class="p">);</span>
</code></pre></div></div>

<p>Now, we need to define the layout for this buffer. WebGPU calls this a vertex
buffer layout, but you’ll notice the <code class="language-plaintext highlighter-rouge">stepMode</code> is defined as <code class="language-plaintext highlighter-rouge">"instance"</code>. This
means that the same data is used for <strong>all</strong> vertices of a given
model/mesh/instance. I think it’s a called a <code class="language-plaintext highlighter-rouge">GPUVertexBufferLayout</code> because
it’s a buffer for the vertex shader, not because it necessarily represents
vertex data (citation needed).</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">instanceBufferLayout</span><span class="p">:</span> <span class="nx">GPUVertexBufferLayout</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">stepMode</span><span class="p">:</span> <span class="dl">"</span><span class="s2">instance</span><span class="dl">"</span><span class="p">,</span>
  <span class="na">arrayStride</span><span class="p">:</span> <span class="mi">64</span><span class="p">,</span>
  <span class="na">attributes</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="c1">// column #1</span>
      <span class="na">format</span><span class="p">:</span> <span class="dl">"</span><span class="s2">float32x4</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">offset</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="na">shaderLocation</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="c1">// column #2</span>
      <span class="na">format</span><span class="p">:</span> <span class="dl">"</span><span class="s2">float32x4</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">offset</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
      <span class="na">shaderLocation</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="c1">// column #3</span>
      <span class="na">format</span><span class="p">:</span> <span class="dl">"</span><span class="s2">float32x4</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">offset</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>
      <span class="na">shaderLocation</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="c1">// column #4</span>
      <span class="na">format</span><span class="p">:</span> <span class="dl">"</span><span class="s2">float32x4</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">offset</span><span class="p">:</span> <span class="mi">48</span><span class="p">,</span>
      <span class="na">shaderLocation</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
    <span class="p">},</span>
  <span class="p">],</span>
<span class="p">};</span>
</code></pre></div></div>

<p>Painfully, I don’t think we have a natural way of providing a <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn><mo>×</mo><mn>4</mn></mrow><annotation encoding="application/x-tex">4\times4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">4</span></span></span></span>
matrix. So, we’ll stitch this back up in our shader. While we’re still in the
<code class="language-plaintext highlighter-rouge">main.ts</code> file, let’s update the “glue” – as I call it<sup id="fnref:5" role="doc-noteref"><a href="#fn:5" class="footnote" rel="footnote">5</a></sup>.</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">pipeline</span> <span class="o">=</span> <span class="nx">device</span><span class="p">.</span><span class="nx">createRenderPipeline</span><span class="p">({</span>
  <span class="na">vertex</span><span class="p">:</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="na">buffers</span><span class="p">:</span> <span class="p">[</span><span class="nx">vertexBufferLayout</span><span class="p">,</span> <span class="nx">instanceBufferLayout</span><span class="p">],</span> <span class="c1">// updated</span>
  <span class="p">},</span>
  <span class="p">...</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Then, update the render pass to bind this new buffer:</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">pass</span><span class="p">.</span><span class="nx">setVertexBuffer</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">instanceBuffer</span><span class="p">);</span>
</code></pre></div></div>

<p>Finally, we can define this in the shader. We first add our struct which matches
the buffer layout above:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">InstanceInput</span> <span class="p">{</span>
  <span class="o">@</span><span class="nf">location</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="n">model_matrix_0</span><span class="p">:</span> <span class="n">vec4</span><span class="o">&lt;</span><span class="nb">f32</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="o">@</span><span class="nf">location</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="n">model_matrix_1</span><span class="p">:</span> <span class="n">vec4</span><span class="o">&lt;</span><span class="nb">f32</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="o">@</span><span class="nf">location</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="n">model_matrix_2</span><span class="p">:</span> <span class="n">vec4</span><span class="o">&lt;</span><span class="nb">f32</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="o">@</span><span class="nf">location</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="n">model_matrix_3</span><span class="p">:</span> <span class="n">vec4</span><span class="o">&lt;</span><span class="nb">f32</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We then update our vertex shader with a new <code class="language-plaintext highlighter-rouge">instance</code> input, stitch up a new
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn><mo>×</mo><mn>4</mn></mrow><annotation encoding="application/x-tex">4\times4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">4</span></span></span></span> matrix, and use it in our completed MVP calculation!</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">vertex</span>
<span class="k">fn</span> <span class="nf">vertexMain</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="n">VertexInput</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">InstanceInput</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">VertexOutput</span> <span class="p">{</span>
  <span class="n">var</span> <span class="n">output</span><span class="p">:</span> <span class="n">VertexOutput</span><span class="p">;</span>
  <span class="k">let</span> <span class="n">model</span> <span class="o">=</span> <span class="nf">mat4x4f</span><span class="p">(</span>
    <span class="n">instance</span><span class="py">.model_matrix_0</span><span class="p">,</span>
    <span class="n">instance</span><span class="py">.model_matrix_1</span><span class="p">,</span>
    <span class="n">instance</span><span class="py">.model_matrix_2</span><span class="p">,</span>
    <span class="n">instance</span><span class="py">.model_matrix_3</span><span class="p">,</span>
  <span class="p">);</span>
  <span class="n">output</span><span class="py">.clip_pos</span> <span class="o">=</span> <span class="n">uniforms</span><span class="py">.viewProj</span> <span class="o">*</span> <span class="n">model</span> <span class="o">*</span> <span class="nf">vec4f</span><span class="p">(</span><span class="k">in</span><span class="py">.pos.xyz</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">output</span><span class="py">.uv</span> <span class="o">=</span> <span class="k">in</span><span class="py">.uv</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">output</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Oh, nothing has changed…</p>

<p>Right, for some feeling of progress, mess around with your identity matrix.
Double one of the values, apply a transformation. Just remember to avoid shear
transformations and put things back where they were, otherwise…</p>

<p><img src="/assets/webgpu-game-4-depth-and-instances/cube-gore.png" alt="Cube gore" class="centered" /></p>

<h2 id="footnotes">Footnotes</h2>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>Except for the bottom face – I’m lazy and it will just cause more GPU cycles for no reason. I may even remove two more faces we’ll never see, moving forward. <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p>In fact, I believe it can be achieved with a single cross product, dot product and comparison. This is cheaper than a single run of the fragment shader in most games with any lighting calculations. <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p>But for completeness: <a href="https://en.wikipedia.org/wiki/Stencil_buffer">https://en.wikipedia.org/wiki/Stencil_buffer</a> <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:4" role="doc-endnote">
      <p>Misdirection is better suited to magicians, I apologize for the deceit. <a href="#fnref:4" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:5" role="doc-endnote">
      <p>I often forget where exactly to bind things with this API. Don’t feel bad repeatedly referring back to the same documentation (or type definitions), I shamelessly <strong>don’t</strong>! <a href="#fnref:5" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

  </div>

  <!-- Show links to previous and next post if in a series --><div class="post-nav"><hr/>
          <h3>WebGPU game series links</h3><div class="post-nav-links"><div class="post-nav-prev">
              <a href="/graphics/2023/07/04/webgpu-game-3-textures-and-projections.html">&laquo; WebGPU game (#3): Textures and Projections</a>
            </div><div class="post-nav-next">
              <a href="/graphics/2023/07/11/webgpu-game-5-player-look-at.html">WebGPU game (#5): Player Look-At &raquo;</a>
            </div></div>
        </div><a class="u-url" href="/graphics/2023/07/06/webgpu-game-4-depth-and-instances.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">
    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Byron&#39;s Blog
            </li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/battesonb"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">battesonb</span></a></li><li><a href="https://www.twitter.com/battesonb"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">battesonb</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>A blog about web, software, computer science and related fields.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
